# Developer Reference

## Essential Commands

### Package Development (`devtools`)

```r
# Load package for development
devtools::load_all()

# Install all dependencies  
devtools::install_deps(dependencies = TRUE)

# Check package (like R CMD check)
devtools::check()

# Run all tests
devtools::test()

# Run specific test file
devtools::test_active_file('tests/testthat/test-plot-customization.R')

# Install package locally
devtools::install()
```

### Documentation

```r
# Generate function documentation from roxygen2 comments
devtools::document()

# Build README.md from README.Rmd
devtools::build_readme()

# Build all vignettes
devtools::build_vignettes()

# Build a specific vignette
R -e "devtools::load_all(); rmarkdown::render('vignettes/loss_functions.Rmd')"

# Build package website
pkgdown::build_site()

# Preview website locally
pkgdown::preview_site()
```

### Testing

```r
# Run all tests
devtools::test()

# Run specific test file
testthat::test_file("tests/testthat/test-Objective.R")

# Test with coverage report
covr::package_coverage()

# Interactive test debugging
testthat::test_file("tests/testthat/test-Objective.R", reporter = "tap")
```

### Building

```r
# Build source tarball
devtools::build()

# Build binary package
devtools::build(binary = TRUE)

# Quick build without vignettes
devtools::build(vignettes = FALSE)
```

## Structure

```
vistool/
├── DESCRIPTION         # Package metadata, dependencies
├── NAMESPACE           # Exports (auto-generated by roxygen2)
├── README.Rmd          # Source for GitHub README
├── NEWS.md             # Changelog
├── CONTRIBUTING.md     # This file
├── R/                  # R source code
│   ├── as_visualizer.r # main user interface
│   ├── LossFunction.R  # Loss functions
│   ├── Objective.R     # Objective function classes  
│   ├── Optimizer.R     # Optimization algorithms
│   ├── Visualizer*.R   # Visualization classes
│   └── zzz.R           # Package imports
├── man/                # Documentation (auto-generated)
├── man-roxygen/        # Roxygen2 templates  
├── tests/testthat/     # Test files
├── vignettes/          # Long-form documentation
└── .github/workflows/  # CI/CD
```

## Core Architecture (Visualization)

- **`Visualizer`**: Base visualization class
  - `Visualizer1D*`: 1D plotting with ggplot2
  - `Visualizer2D*`: 2D plotting with ggplot2  
  - `VisualizerSurface*`: Interactive surface plotting with plotly for 2D functions
- **`as_visualizer()`**: Smart constructor that selects appropriate visualizer

### Deferred Rendering

All visualizer classes (should) use a deferred rendering architecture:

- **Layer Storage**: All `add_*()` methods (e.g., `$add_points()`, `$add_contours()`, etc.) do not modify the plot directly. Instead, they call the private method `$store_layer(type, spec)` to save a specification of the layer (its type and parameters) to an internal list.
- **Rendering**: The `$plot()` method is responsible for rendering all stored layers. It iterates over the stored layer specifications and calls a private `$render_layer(layer)` method to add each layer to the plot object. This ensures that all visual properties (such as colors, alpha, etc.) are resolved at plot time, using the current global settings.
- **Customization**: Global settings (e.g., color palette, theme, text size) are set via `$plot()`. Layer-specific settings are passed to the relevant `add_*()` method and stored with the layer specification. Defaults are set at initialization.
- **Benefits**: This pattern ensures that plots are always up-to-date with the latest settings, supports re-plotting with different global options, and makes it easier to add, remove, or reorder layers.

### Color Management

vistool uses a unified color management system to ensure consistent colors across ggplot2 and plotly visualizations (`color_management.R`). The system supports both discrete colors (for points, traces, lines) and continuous color scales (for surfaces, contours).

**Integration with Deferred Rendering**: Colors marked as `"auto"` in layer specifications are resolved at plot time using the current `color_palette` setting. This ensures colors match the selected palette.

### Example Workflow

```r
viz <- as_visualizer(obj, type = "surface")
viz$add_points(points = my_points)
viz$add_contours(contours = my_contours)
# No plot is created yet!

viz$plot(color_palette = "grayscale")  # All layers are rendered now, also resolving colors
```

## Development Workflow

### 1. Setup Development Environment

```bash
git clone https://github.com/slds-lmu/vistool.git
cd vistool
```

```r
devtools::load_all()
devtools::install_deps(dependencies = TRUE)
```

### 2. Make Changes

Edit files in `R/`, add roxygen2 documentation:

```r
#' @title Brief description
#' @description Detailed description  
#' @param x Parameter description
#' @return Return value description
#' @examples
#' # Example code
#' @export
my_function = function(x) {
  # Implementation
}
```

For reusable documentation blocks, consider using templates from `man-roxygen/` directory.

### 3. Update Documentation

```r
devtools::document()  # Generate man/ files
devtools::build_readme()  # Update README.md
```

### 4. Add Tests

Test all public functions using `testthat`:

```r
test_that("my feature works", {
  result = my_function(input)
  expect_equal(result, expected)
})
```

### 5. Check Package

```r
devtools::test()    # Run tests
devtools::check()   # Full package check
```

You can also check the rendered website:

```r
pkgdown::build_site()
```

## Guidelines

### Testing

- Each R file should have corresponding test file
- Use descriptive test names: `test_that("objective evaluation works", ...)`
- Test both success and failure cases
- Use appropriate `expect_*()` functions

```r
# Skip tests requiring Python dependencies on CI
skip_on_ci()

# Skip if optional package not available  
skip_if_not_installed("plotly")
```

### Documentation with `roxygen2`

- Use `roxygen2` tags (`@title`, `@description`, `@param`, `@return`, `@examples`)
- Include working examples
- Document all parameters
- Use consistent style with existing code
- For reusable documentation blocks, use templates in `man-roxygen/` directory.
