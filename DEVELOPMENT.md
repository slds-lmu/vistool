# Developer Reference

## Essential Commands

### Package Development (`devtools`)

```r
# Load package for development
devtools::load_all()

# Install all dependencies  
devtools::install_deps(dependencies = TRUE)

# Check package (like R CMD check)
devtools::check()

# Run all tests
devtools::test()

# Run specific test file
devtools::test_active_file('tests/testthat/test-plot-customization.R')

# Install package locally
devtools::install()
```

### Documentation

```r
# Generate function documentation from roxygen2 comments
devtools::document()

# Build README.md from README.Rmd
devtools::build_readme()

# Build all vignettes
devtools::build_vignettes()

# Build a specific vignette
R -e "devtools::load_all(); rmarkdown::render('vignettes/loss_functions.Rmd')"

# Build package website
pkgdown::build_site()

# Preview website locally
pkgdown::preview_site()
```

### Testing

```r
# Run all tests
devtools::test()

# Run specific test file
testthat::test_file("tests/testthat/test-Objective.R")

# Test with coverage report
covr::package_coverage()

# Interactive test debugging
testthat::test_file("tests/testthat/test-Objective.R", reporter = "tap")
```

### Building

```r
# Build source tarball
devtools::build()

# Build binary package
devtools::build(binary = TRUE)

# Quick build without vignettes
devtools::build(vignettes = FALSE)
```

## Structure

```
vistool/
├── DESCRIPTION         # Package metadata, dependencies
├── NAMESPACE           # Exports (auto-generated by roxygen2)
├── README.Rmd          # Source for GitHub README
├── NEWS.md             # Changelog
├── CONTRIBUTING.md     # This file
├── R/                  # R source code
│   ├── as_visualizer.r # main user interface
│   ├── LossFunction.R  # Loss functions
│   ├── Objective.R     # Objective function classes  
│   ├── Optimizer.R     # Optimization algorithms
│   ├── Visualizer*.R   # Visualization classes
│   └── zzz.R           # Package imports
├── man/                # Documentation (auto-generated)
├── man-roxygen/        # Roxygen2 templates  
├── tests/testthat/     # Test files
├── vignettes/          # Long-form documentation
└── .github/workflows/  # CI/CD
```

## Core Architecture (Visualization)

- **`Visualizer`**: Base visualization class
  - `Visualizer1D*`: 1D plotting with ggplot2
  - `Visualizer2D*`: 2D plotting with ggplot2  
  - `VisualizerSurface*`: Interactive surface plotting with plotly for 2D functions
- **`as_visualizer()`**: Smart constructor that selects appropriate visualizer

## Deferred Rendering

All visualizer classes in vistool follow a standardized `plot()` method structure that leverages the deferred rendering architecture. This ensures consistent behavior, proper color resolution, and maintainable code.

### Standard Pattern

#### `Visualizer.R`

The base `Visualizer` class provides:
- **Layer storage**: `private$store_layer(type, spec)` 
- **Layer retrieval**: `private$get_layers_by_type(type)`
- **Plot settings**: Stored in `private$.plot_settings` for color resolution
- **Common parameters**: text_size, theme, color_palette, etc.

CAREFUL: Its `plot()` method is **abstract** and needs to be implemented by `Visualizer1D.R`, `Visualizer2D.R`, `VisualizerSurface.R` (and `VisualizerLossFuns`)!

#### 2. `Visualizer1D.R`, `Visualizer2D.R`, `VisualizerSurface.R` (and `VisualizerLossFuns`)
These implement the abstract `plot()` method from the base `Visualizer` class and methods specific for that type/dimension (e.g., `add_contours()` for all `VisualizerSurface` classes), they inherit from `Visualizer`.

#### 3. Child Class `plot()` Structure

Every (grand-) child class (e.g., `Visualizer1DObj`, `Visualizer2DModel`, `VisualizerSurfaceObj`) should follow this exact pattern:

```r
plot = function(...) {
  # 1. ALWAYS call parent first to set up plot_settings and base plot
  p <- super$plot(...)  # or just super$plot(...) for plotly classes
  
  # 2. Render class-specific layers using dedicated private methods
  private$render_layer_type_1()
  private$render_layer_type_2()
  # ... etc
  
  # 3. Return the plot object (for ggplot2 classes only)
  return(p)  # omit for plotly classes that modify private$.plot
}
```

### Implementation Examples

#### ggplot2-based Classes (1D, 2D)

```r
# Good Example: Visualizer2DObj
plot = function(...) {
  # Call parent to get base plot and set plot_settings
  p <- super$plot(...)
  
  # Render stored layers
  private$render_optimization_trace_layers(p)
}

private = list(
  render_optimization_trace_layers = function(plot_obj) {
    trace_layers <- private$get_layers_by_type("optimization_trace")
    
    if (length(trace_layers) == 0) {
      return(plot_obj)
    }
    
    for (trace_spec in trace_layers) {
      plot_obj <- private$render_optimization_trace_layer(plot_obj, trace_spec)
    }
    
    return(plot_obj)
  }
)
```

#### plotly-based Classes (Surface)

```r
# Good Example: VisualizerSurfaceObj  
plot = function(...) {
  # Call parent to set up plot_settings and resolve colors
  super$plot(...)
  
  # Render stored layers (modifies private$.plot directly)
  private$render_optimization_trace_layers()
  private$render_taylor_layers()
  private$render_hessian_layers()
  
  return(private$.plot)
}

private = list(
  render_optimization_trace_layers = function() {
    trace_layers <- private$get_layers_by_type("optimization_trace")
    # ... process layers, modify private$.plot directly
  }
)
```


## Development Workflow

### 1. Setup Development Environment

```bash
git clone https://github.com/slds-lmu/vistool.git
cd vistool
```

```r
devtools::load_all()
devtools::install_deps(dependencies = TRUE)
```

### 2. Make Changes

Edit files in `R/`, add roxygen2 documentation:

```r
#' @title Brief description
#' @description Detailed description  
#' @param x Parameter description
#' @return Return value description
#' @examples
#' # Example code
#' @export
my_function = function(x) {
  # Implementation
}
```

For reusable documentation blocks, consider using templates from `man-roxygen/` directory.

### 3. Update Documentation

```r
devtools::document()  # Generate man/ files
devtools::build_readme()  # Update README.md
```

### 4. Add Tests

Test all public functions using `testthat`:

```r
test_that("my feature works", {
  result = my_function(input)
  expect_equal(result, expected)
})
```

### 5. Check Package

```r
devtools::test()    # Run tests
devtools::check()   # Full package check
```

You can also check the rendered website:

```r
pkgdown::build_site()
```

## Guidelines

### Testing

- Each R file should have corresponding test file
- Use descriptive test names: `test_that("objective evaluation works", ...)`
- Test both success and failure cases
- Use appropriate `expect_*()` functions

```r
# Skip tests requiring Python dependencies on CI
skip_on_ci()

# Skip if optional package not available  
skip_if_not_installed("plotly")
```

### Documentation with `roxygen2`

- Use `roxygen2` tags (`@title`, `@description`, `@param`, `@return`, `@examples`)
- Include working examples
- Document all parameters
- Use consistent style with existing code
- For reusable documentation blocks, use templates in `man-roxygen/` directory.
